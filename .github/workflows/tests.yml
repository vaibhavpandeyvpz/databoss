name: Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]

jobs:
  test:
    name: PHP ${{ matrix.php-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php-version:
          - "8.2"
          - "8.3"
          - "8.4"

    services:
      mysql:
        image: mysql:8.0
        ports:
          - 3306:3306
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testdb
        options: >-
          --health-cmd "mysqladmin ping -h localhost -u root -proot"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: testdb
        options: >-
          --health-cmd "pg_isready -U postgres"
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      sqlserver:
        image: mcr.microsoft.com/mssql/server:2022-latest
        ports:
          - 1433:1433
        env:
          ACCEPT_EULA: "Y"
          SA_PASSWORD: "YourStrong!Passw0rd"
          MSSQL_PID: "Developer"
        options: >-
          --health-cmd "exit 0"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install unixodbc (Linux/macOS requirement)
        run: |
          sudo apt-get update
          sudo apt-get install unixodbc -y

      - name: Install sqlcmd
        run: |
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y mssql-tools18 unixodbc-dev
          echo "/opt/mssql-tools18/bin" >> $GITHUB_PATH

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          coverage: xdebug
          extensions: pdo_mysql, pdo_pgsql, pdo_sqlite, pdo_sqlsrv
          tools: composer

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-composer-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install database clients
        run: |
          sudo apt-get update
          sudo apt-get install -y default-mysql-client postgresql-client

      - name: Wait for SQL Server to be ready
        run: |
          echo "Waiting for SQL Server..."
          for i in {1..60}; do
            if sqlcmd \
              -S 127.0.0.1 \
              -U sa \
              -P 'YourStrong!Passw0rd' \
              -C \
              -Q "SELECT 1" >/dev/null 2>&1; then
              echo "SQL Server is ready"
              exit 0
            fi
            sleep 2
          done
          echo "SQL Server did not become ready in time"
          exit 1

      - name: Initialize database schemas
        run: |
          mysql -h 127.0.0.1 -u root -proot testdb < dumps/mysql.sql
          PGPASSWORD=postgres psql -h 127.0.0.1 -U postgres -d testdb -f dumps/postgres.sql
          sqlcmd -S 127.0.0.1 -U sa -P 'YourStrong!Passw0rd' -C -i dumps/sqlserver.sql

      - name: Run tests
        run: vendor/bin/phpunit --coverage-text
        env:
          XDEBUG_MODE: coverage
